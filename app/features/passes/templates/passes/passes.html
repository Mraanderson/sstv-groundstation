{% extends "base.html" %}
{% block title %}Satellite Pass Predictions{% endblock %}
{% block content %}
<h1 class="mb-4">🛰️ Satellite Pass Predictions</h1>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    {% if tle_info %}
      <p><strong>TLE File:</strong> {{ tle_info.filename }}</p>
      <p>
        <strong>Last Updated:</strong> {{ tle_info.last_updated }}
        {% if tle_info.age_days is not none %}
          <span class="text-muted">({{ tle_info.age_days|round(1) }} days old)</span>
        {% endif %}
      </p>
      <p><strong>Satellites in TLE:</strong> {{ satellites|length }}</p>
    {% else %}
      <p class="text-warning">No TLE data found.</p>
    {% endif %}

    <button id="update-tle-btn" class="btn btn-primary me-3">
      <span id="update-icon" class="me-2">🔄</span> Update TLE
    </button>

    <!-- Single toggle button for recordings -->
    <button id="toggleBtn" class="btn btn-secondary">Loading...</button>
    <span id="statusText" class="ms-3 fw-bold"></span>
  </div>
</div>

{% if not sdr_present %}
  <div class="alert alert-warning">
    ⚠ No RTL‑SDR detected — pass quality will not be recorded.
  </div>
{% endif %}

{% if not location_set %}
  <div class="alert alert-info">
    Please set your location on the Config page to enable pass predictions.
  </div>
{% endif %}

{% if error %}
  <div class="alert alert-warning">{{ error }}</div>
{% endif %}

{% if passes %}
  <div class="card shadow-sm">
    <div class="card-body">
      <h5>Next 24 Hours of Passes</h5>

      <!-- Pass Timeline Bar -->
      <div id="pass-timeline-container" class="mb-4" style="display: none;">
        <h6>Current Pass Timeline</h6>
        <div style="position: relative; width: 100%; max-width: 600px; height: 32px; background: #e9ecef; border-radius: 16px; overflow: hidden;">
          <div id="pass-timeline-bar" style="height: 100%; background: linear-gradient(90deg, #007bff, #00c6ff); width: 0%; transition: width 0.5s;"></div>
          <div id="pass-timeline-label" style="position: absolute; left: 50%; top: 0; width: 100%; text-align: center; line-height: 32px; font-weight: bold; color: #222; pointer-events: none;">No pass in progress</div>
        </div>
      </div>

      <!-- Desktop table -->
      <div class="table-responsive d-none d-md-block">
        <table class="table table-striped align-middle">
          <thead class="table-dark">
            <tr>
              <th>🛰️ Satellite</th>
              <th>⏫ Max Elev</th>
              <th>▶ Start</th>
              <th>🔝 Peak</th>
              <th>⏹ End</th>
              <th>⏳ Duration</th>
            </tr>
          </thead>
          <tbody>
            {% set ns = namespace(current_day=None) %}
            {% for p in passes %}
              {% if ns.current_day != p.start.strftime("%Y-%m-%d") %}
                <tr class="table-secondary">
                  <td colspan="6">{{ p.start | datetimeformat("%A %d %B") }}</td>
                </tr>
                {% set ns.current_day = p.start.strftime("%Y-%m-%d") %}
              {% endif %}
              {% set now = now or none %}
              {% set in_progress = (now and p.start <= now <= p.end) %}
              <tr>
                <td>{% if in_progress %}<span title="Pass in progress" style="color:#007bff;">⏳</span> {% endif %}{{ p.satellite }}</td>
                <td class="{% if p.max_elevation > 50 %}text-success fw-bold{% elif p.max_elevation > 20 %}text-warning{% else %}text-muted{% endif %}">
                  {{ "%.1f"|format(p.max_elevation) }}°
                </td>
                <td title="{{ p.start | datetimeformat('%Y-%m-%d %H:%M:%S') }}">
                  {{ p.start | datetimeformat('%H:%M') }}
                </td>
                <td title="{{ p.peak | datetimeformat('%Y-%m-%d %H:%M:%S') }}">
                  {{ p.peak | datetimeformat('%H:%M') }}
                </td>
                <td title="{{ p.end | datetimeformat('%Y-%m-%d %H:%M:%S') }}">
                  {{ p.end | datetimeformat('%H:%M') }}
                </td>
                <td>{{ ((p.end - p.start).seconds // 60) }} min</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Mobile cards -->
      <div class="d-md-none">
        {% set ns = namespace(current_day=None) %}
        {% for p in passes %}
          {% if ns.current_day != p.start.strftime("%Y-%m-%d") %}
            <h6 class="mt-3 text-muted">{{ p.start | datetimeformat("%A %d %B") }}</h6>
            {% set ns.current_day = p.start.strftime("%Y-%m-%d") %}
          {% endif %}
          {% set now = now or none %}
          {% set in_progress = (now and p.start <= now <= p.end) %}
          <div class="card mb-2 shadow-sm">
            <div class="card-body">
              <h5 class="card-title">
                {% if in_progress %}<span title="Pass in progress" style="color:#007bff;">⏳</span> {% endif %}{{ p.satellite }} —
                <span class="{% if p.max_elevation > 50 %}text-success{% elif p.max_elevation > 20 %}text-warning{% else %}text-muted{% endif %}">
                  ⏫ {{ "%.1f"|format(p.max_elevation) }}°
                </span>
              </h5>
              <p class="card-text mb-1">▶ Start: {{ p.start | datetimeformat('%H:%M') }}</p>
              <p class="card-text mb-1">🔝 Peak: {{ p.peak | datetimeformat('%H:%M') }}</p>
              <p class="card-text mb-1">⏹ End: {{ p.end | datetimeformat('%H:%M') }}</p>
              <p class="card-text">⏳ Duration: {{ ((p.end - p.start).seconds // 60) }} min</p>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% elif tle_info and not error %}
  <p>No passes found in the next 24 hours.</p>
{% endif %}

<script>
  // --- Pass Timeline Logic ---
  async function updatePassTimeline() {
    try {
      const res = await fetch('/timeline');
      if (!res.ok) throw new Error('timeline not ok');
      const data = await res.json();
      const timeline = data.timeline || [];
      const now = new Date();
      // Find the in-progress pass
      const current = timeline.find(p => p.status === 'in_progress');
      const bar = document.getElementById('pass-timeline-bar');
      const label = document.getElementById('pass-timeline-label');
      const container = document.getElementById('pass-timeline-container');
      if (current) {
        container.style.display = '';
        const start = new Date(current.start);
        const end = new Date(current.end);
        const total = end - start;
        const elapsed = now - start;
        let percent = Math.max(0, Math.min(100, (elapsed / total) * 100));
        bar.style.width = percent + '%';
        label.textContent = `${current.satellite}: ${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
      } else {
        container.style.display = 'none';
        bar.style.width = '0%';
        label.textContent = 'No pass in progress';
      }
    } catch (err) {
      // fallback
      const bar = document.getElementById('pass-timeline-bar');
      const label = document.getElementById('pass-timeline-label');
      bar.style.width = '0%';
      label.textContent = 'Timeline unavailable';
    }
  }
  setInterval(updatePassTimeline, 5000);
  updatePassTimeline();
  // Update TLE button logic
  document.getElementById('update-tle-btn').addEventListener('click', function () {
    const btn = this;
    const icon = document.getElementById('update-icon');
    btn.disabled = true;
    icon.textContent = '⏳';

    fetch('{{ url_for("passes.update_tle") }}')
      .then(res => res.json())
      .then(data => {
        icon.textContent = '✅';
        setTimeout(() => { location.reload(); }, 800);
      })
      .catch(err => {
        icon.textContent = '⚠️';
        btn.disabled = false;
      });
  });

  // Recording toggle button logic
  const toggleBtn = document.getElementById('toggleBtn');
  const statusText = document.getElementById('statusText');

  async function updateStatus() {
    try {
      const res = await fetch('/recordings/status');
      if (!res.ok) throw new Error('status not ok');
      const data = await res.json();
      const enabled = data.recording_enabled;

      statusText.textContent = enabled
        ? `✅ Enabled${data.scheduler_pid ? ` (PID: ${data.scheduler_pid})` : ''}`
        : '❌ Disabled';

      if (enabled) {
        toggleBtn.textContent = 'Disable Recordings';
        toggleBtn.className = 'btn btn-danger';
        toggleBtn.onclick = async () => {
          await fetch('/recordings/disable', { method: 'POST' });
          updateStatus();
        };
      } else {
        toggleBtn.textContent = 'Enable Recordings';
        toggleBtn.className = 'btn btn-success';
        toggleBtn.onclick = async () => {
          await fetch('/recordings/enable', { method: 'POST' });
          updateStatus();
        };
      }
    } catch (err) {
      statusText.textContent = '⚠️ Error fetching status';
      toggleBtn.textContent = 'Retry';
      toggleBtn.className = 'btn btn-secondary';
      toggleBtn.onclick = updateStatus;
    }
  }

  // Poll status every 5 seconds
  setInterval(updateStatus, 5000);
  updateStatus();
</script>
{% endblock %}
