{% extends "base.html" %}
{% block title %}Satellite Passes{% endblock %}
{% block content %}
<h1 class="mb-4">Satellite Pass Predictions</h1>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    {% if tle_info %}
      <p><strong>TLE File:</strong> {{ tle_info.filename }}</p>
      <p><strong>Last Updated:</strong> {{ tle_info.last_updated }}
        <span class="text-muted">({{ tle_info.age_days|round(1) }} days old)</span>
      </p>
      <p><strong>Satellites in TLE:</strong> {{ satellites|length }}</p>
    {% else %}
      <p class="text-warning">No TLE data found.</p>
    {% endif %}
    <button id="update-tle-btn" class="btn btn-primary me-3">
      <span id="update-icon" class="me-2">ðŸ”„</span> Update TLE
    </button>

    <!-- Recording toggle controls -->
    <button id="enableBtn" class="btn btn-success me-2">Enable Recordings</button>
    <button id="disableBtn" class="btn btn-danger">Disable Recordings</button>
    <span id="statusText" class="ms-3 fw-bold"></span>
  </div>
</div>

{% if not sdr_present %}
  <div class="alert alert-warning">
    âš  No RTLâ€‘SDR detected â€” pass quality will not be recorded.
  </div>
{% endif %}

{% if not location_set %}
  <div class="alert alert-info">
    Please set your location in the Config page to enable pass predictions.
  </div>
{% endif %}

{% if error %}
  <div class="alert alert-warning">{{ error }}</div>
{% endif %}

{% if passes %}
  <div class="card shadow-sm">
    <div class="card-body">
      <h5>Next 24 Hours of Passes</h5>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Satellite</th>
            <th>Max Elev (Â°)</th>
            <th>Start</th>
            <th>Peak</th>
            <th>End</th>
          </tr>
        </thead>
        <tbody>
          {% for p in passes %}
            <tr>
              <td>{{ p.satellite }}</td>
              <td>{{ p.max_elevation }}</td>
              <td>{{ p.start.strftime("%Y-%m-%d %H:%M:%S") }}</td>
              <td>{{ p.peak.strftime("%Y-%m-%d %H:%M:%S") }}</td>
              <td>{{ p.end.strftime("%Y-%m-%d %H:%M:%S") }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% elif tle_info and not error %}
  <p>No passes found in the next 24 hours.</p>
{% endif %}

<script>
  // Update TLE button logic
  document.getElementById('update-tle-btn').addEventListener('click', function () {
    const btn = this;
    const icon = document.getElementById('update-icon');
    btn.disabled = true;
    icon.textContent = 'â³';

    fetch('{{ url_for("passes.update_tle") }}')
      .then(res => res.json())
      .then(data => {
        icon.textContent = 'âœ…';
        setTimeout(() => {
          location.reload();
        }, 1000);
      })
      .catch(err => {
        icon.textContent = 'âš ï¸';
        btn.disabled = false;
      });
  });

  // Recording toggle logic
  const statusText = document.getElementById('statusText');
  const enableBtn = document.getElementById('enableBtn');
  const disableBtn = document.getElementById('disableBtn');

  async function updateStatus() {
    try {
      const res = await fetch('/recordings/status');
      const data = await res.json();
      const enabled = data.recording_enabled;

      statusText.textContent = enabled
        ? `âœ… Enabled (PID: ${data.scheduler_pid || 'N/A'})`
        : 'âŒ Disabled';

      // Toggle button states
      enableBtn.disabled = enabled;
      disableBtn.disabled = !enabled;
    } catch (err) {
      statusText.textContent = 'âš ï¸ Error fetching status';
      enableBtn.disabled = false;
      disableBtn.disabled = false;
    }
  }

  enableBtn.addEventListener('click', async () => {
    await fetch('/recordings/enable', { method: 'POST' });
    updateStatus();
  });

  disableBtn.addEventListener('click', async () => {
    await fetch('/recordings/disable', { method: 'POST' });
    updateStatus();
  });

  // Poll status every 5 seconds
  setInterval(updateStatus, 5000);
  updateStatus();
</script>
{% endblock %}
