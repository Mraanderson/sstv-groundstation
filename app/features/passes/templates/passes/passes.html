{% extends "base.html" %}
{% block title %}Satellite Pass Predictions{% endblock %}
{% block content %}
<h1 class="mb-4">🛰️ Satellite Pass Predictions</h1>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    {% if tle_info %}
      <p><strong>TLE File:</strong> {{ tle_info.filename }}</p>
      <p><strong>Last Updated:</strong> {{ tle_info.last_updated }}
        {% if tle_info.age_days is not none %}
          <span class="text-muted">({{ tle_info.age_days|round(1) }} days old)</span>
        {% endif %}
      </p>
      <p><strong>Satellites in TLE:</strong> {{ satellites|length }}</p>
    {% else %}
      <p class="text-warning">No TLE data found.</p>
    {% endif %}
    <button id="update-tle-btn" class="btn btn-primary me-3"><span id="update-icon" class="me-2">🔄</span> Update TLE</button>
    <button id="toggleBtn" class="btn btn-secondary">Loading...</button>
    <span id="statusText" class="ms-3 fw-bold"></span>
  </div>
</div>

{% if not sdr_present %}<div class="alert alert-warning">⚠ No RTL‑SDR detected — pass quality will not be recorded.</div>{% endif %}
{% if not location_set %}<div class="alert alert-info">Please set your location on the Config page to enable pass predictions.</div>{% endif %}
{% if error %}<div class="alert alert-warning">{{ error }}</div>{% endif %}

{% if passes %}
<div class="card shadow-sm"><div class="card-body">
  <h5>Next 48 Hours of Passes</h5>
  <div id="pass-timeline-container" class="mb-4" style="display:none;">
    <h6>Current Pass Timeline</h6>
    <div style="position:relative;max-width:600px;height:32px;background:#e9ecef;border-radius:16px;overflow:hidden;">
      <div id="pass-timeline-bar" style="height:100%;background:linear-gradient(90deg,#007bff,#00c6ff);width:0%;transition:width .5s;"></div>
      <div id="pass-timeline-label" style="position:absolute;left:0;top:0;width:100%;text-align:center;line-height:32px;font-weight:bold;color:#222;">No pass in progress</div>
    </div>
  </div>

  <!-- Desktop table -->
  <div class="table-responsive d-none d-md-block">
    <table class="table table-striped align-middle">
      <thead class="table-dark"><tr><th>🛰️</th><th>⏫ Max</th><th>▶ Start</th><th>🔝 Peak</th><th>⏹ End</th><th>⏳ Dur</th></tr></thead>
      <tbody>
        {% set ns = namespace(current_day=None) %}
        {% for p in passes %}
          {% if ns.current_day != p.start.strftime("%Y-%m-%d") %}
            <tr class="table-secondary"><td colspan="6">{{ p.start|datetimeformat("%A %d %B") }}</td></tr>
            {% set ns.current_day = p.start.strftime("%Y-%m-%d") %}
          {% endif %}
          {% set in_progress = (now and p.start <= now <= p.end) %}
          <tr>
            <td>{% if in_progress %}⏳ {% endif %}{{ p.satellite }}</td>
            <td class="{% if p.max_elevation>50 %}text-success fw-bold{% elif p.max_elevation>20 %}text-warning{% else %}text-muted{% endif %}">{{ "%.1f"|format(p.max_elevation) }}°</td>
            <td>{{ p.start|datetimeformat('%H:%M') }}</td>
            <td>{{ p.peak|datetimeformat('%H:%M') }}</td>
            <td>{{ p.end|datetimeformat('%H:%M') }}</td>
            <td>{{ ((p.end-p.start).seconds//60) }} min</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Mobile cards -->
  <div class="d-md-none">
    {% set ns = namespace(current_day=None) %}
    {% for p in passes %}
      {% if ns.current_day != p.start.strftime("%Y-%m-%d") %}
        <h6 class="mt-3 text-muted">{{ p.start|datetimeformat("%A %d %B") }}</h6>
        {% set ns.current_day = p.start.strftime("%Y-%m-%d") %}
      {% endif %}
      {% set in_progress = (now and p.start <= now <= p.end) %}
      <div class="card mb-2 shadow-sm"><div class="card-body">
        <h5 class="card-title">{% if in_progress %}⏳ {% endif %}{{ p.satellite }} —
          <span class="{% if p.max_elevation>50 %}text-success{% elif p.max_elevation>20 %}text-warning{% else %}text-muted{% endif %}">⏫ {{ "%.1f"|format(p.max_elevation) }}°</span>
        </h5>
        <p>▶ Start: {{ p.start|datetimeformat('%H:%M') }}</p>
        <p>🔝 Peak: {{ p.peak|datetimeformat('%H:%M') }}</p>
        <p>⏹ End: {{ p.end|datetimeformat('%H:%M') }}</p>
        <p>⏳ Duration: {{ ((p.end-p.start).seconds//60) }} min</p>
      </div></div>
    {% endfor %}
  </div>
</div></div>
{% elif tle_info and not error %}
  <p>No passes found in the next 48 hours.</p>
{% endif %}

<script>
async function updatePassTimeline(){
  try{
    const res=await fetch('/passes/timeline'); if(!res.ok) throw new Error();
    const passes=await res.json(); const now=new Date();
    const current=passes.find(p=>{const s=new Date(p.aos),e=new Date(p.los);return s<=now&&now<=e;});
    const bar=document.getElementById('pass-timeline-bar'),label=document.getElementById('pass-timeline-label'),cont=document.getElementById('pass-timeline-container');
    if(current){cont.style.display='';const s=new Date(current.aos),e=new Date(current.los);let pct=Math.max(0,Math.min(100,((now-s)/(e-s))*100));bar.style.width=pct+'%';label.textContent=`${current.satellite}: ${s.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} - ${e.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;}
    else{cont.style.display='none';bar.style.width='0%';label.textContent='No pass in progress';}
  }catch{document.getElementById('pass-timeline-bar').style.width='0%';document.getElementById('pass-timeline-label').textContent='Timeline unavailable';}
}
setInterval(updatePassTimeline,5000);updatePassTimeline();

document.getElementById('update-tle-btn').addEventListener('click',function(){
  const btn=this,icon=document.getElementById('update-icon');btn.disabled=true;icon.textContent='⏳';
  fetch('{{ url_for("passes.update_tle") }}').then(r=>r.json()).then(()=>{icon.textContent='✅';setTimeout(()=>location.reload(),800);}).catch(()=>{icon.textContent='⚠️';btn.disabled=false;});
});

const toggleBtn=document.getElementById('toggleBtn'),statusText=document.getElementById('statusText');
async function updateStatus(){
  try{const res=await fetch('/recordings/status');if(!res.ok)throw new Error();const d=await res.json(),en=d.recording_enabled;
    statusText.textContent=en?`✅ Enabled${d.scheduler_pid?` (PID:${d.scheduler_pid})`:''}`:'❌ Disabled';
    toggleBtn.textContent=en?'Disable Recordings':'Enable Recordings';
    toggleBtn.className=en?'btn btn-danger':'btn btn-success';
    toggleBtn.onclick=async()=>{await fetch(en?'/recordings/disable':'/recordings/enable',{method:'POST'});updateStatus();};
  }catch{statusText.textContent='⚠️ Error fetching status';toggleBtn.textContent='Retry';toggleBtn.className='btn btn-secondary';toggleBtn.onclick=updateStatus;}
}
setInterval(updateStatus,5000);updateStatus();
</script>
{% endblock %}
        
