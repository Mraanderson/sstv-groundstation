{% extends "base.html" %}
{% block title %}Satellite Passes{% endblock %}
{% block content %}
<h1 class="mb-4">Satellite Pass Predictions</h1>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    {% if tle_info %}
      <p><strong>TLE File:</strong> {{ tle_info.filename }}</p>
      <p><strong>Last Updated:</strong> {{ tle_info.last_updated }}
        <span class="text-muted">({{ tle_info.age_days|round(1) }} days old)</span>
      </p>
      <p><strong>Satellites in TLE:</strong> {{ satellites|length }}</p>
    {% else %}
      <p class="text-warning">No TLE data found.</p>
    {% endif %}
    <button id="update-tle-btn" class="btn btn-primary">
      <span id="update-icon" class="me-2">üîÑ</span> Update TLE
    </button>
  </div>
</div>

{% if not location_set %}
  <div class="alert alert-info">
    Please set your location in the Config page to enable pass predictions.
  </div>
{% endif %}

{% if error %}
  <div class="alert alert-warning">{{ error }}</div>
{% endif %}

{% if passes %}
  <div class="card shadow-sm">
    <div class="card-body">
      <h5>Next 24 Hours of Passes</h5>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Satellite</th>
            <th>Frequency (MHz)</th>
            <th>Mode</th>
            <th>Event</th>
            <th>Time ({{ timezone }})</th>
          </tr>
        </thead>
        <tbody>
          {% for p in passes %}
            {% set age_hours = (now - p.time).total_seconds() / 3600 %}
            <tr class="{% if age_hours > 0 and age_hours < 12 %}text-muted{% endif %}">
              <td>{{ p.satellite }}</td>
              <td>
                {% for sat in sstv_sats if sat.name == p.satellite %}
                  {{ sat.frequency }}
                {% endfor %}
              </td>
              <td>
                {% for sat in sstv_sats if sat.name == p.satellite %}
                  {{ sat.mode }}
                {% endfor %}
              </td>
              <td>{{ p.event }}</td>
              <td>{{ p.time.strftime("%Y-%m-%d %H:%M:%S") }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% elif tle_info and not error %}
  <p>No passes found in the next 24 hours.</p>
{% endif %}

<script>
  document.getElementById('update-tle-btn').addEventListener('click', function () {
    const btn = this;
    const icon = document.getElementById('update-icon');
    btn.disabled = true;
    icon.textContent = '‚è≥';

    fetch('{{ url_for("passes.update_tle") }}')
      .then(res => res.json())
      .then(data => {
        icon.textContent = '‚úÖ';
        setTimeout(() => {
          location.reload();
        }, 1000);
      })
      .catch(err => {
        icon.textContent = '‚ö†Ô∏è';
        btn.disabled = false;
      });
  });
</script>
{% endblock %}
