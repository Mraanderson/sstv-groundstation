{% extends "base.html" %}
{% block title %}Satellite Passes{% endblock %}
{% block content %}
<h1 class="mb-4">Satellite Pass Predictions</h1>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    {% if tle_info %}
      <p><strong>TLE File:</strong> {{ tle_info.filename }}</p>
      <p>
        <strong>Last Updated:</strong> {{ tle_info.last_updated }}
        {% if tle_info.age_days is not none %}
          <span class="text-muted">({{ tle_info.age_days|round(1) }} days old)</span>
        {% endif %}
      </p>
      <p><strong>Satellites in TLE:</strong> {{ satellites|length }}</p>
    {% else %}
      <p class="text-warning">No TLE data found.</p>
    {% endif %}

    <button id="update-tle-btn" class="btn btn-primary me-3">
      <span id="update-icon" class="me-2">üîÑ</span> Update TLE
    </button>

    <!-- Single toggle button for recordings -->
    <button id="toggleBtn" class="btn btn-secondary">Loading...</button>
    <span id="statusText" class="ms-3 fw-bold"></span>
  </div>
</div>

{% if not sdr_present %}
  <div class="alert alert-warning">
    ‚ö† No RTL‚ÄëSDR detected ‚Äî pass quality will not be recorded.
  </div>
{% endif %}

{% if not location_set %}
  <div class="alert alert-info">
    Please set your location on the Config page to enable pass predictions.
  </div>
{% endif %}

{% if error %}
  <div class="alert alert-warning">{{ error }}</div>
{% endif %}

{% if passes %}
  <div class="card shadow-sm">
    <div class="card-body">
      <h5>Next 24 Hours of Passes</h5>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Satellite</th>
            <th>Max Elev (¬∞)</th>
            <th>Start</th>
            <th>Peak</th>
            <th>End</th>
          </tr>
        </thead>
        <tbody>
          {% for p in passes %}
            <tr>
              <td>{{ p.satellite }}</td>
              <td>{{ p.max_elevation }}</td>
              <td>{{ p.start.strftime("%Y-%m-%d %H:%M:%S") }}</td>
              <td>{{ p.peak.strftime("%Y-%m-%d %H:%M:%S") }}</td>
              <td>{{ p.end.strftime("%Y-%m-%d %H:%M:%S") }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% elif tle_info and not error %}
  <p>No passes found in the next 24 hours.</p>
{% endif %}

<script>
  // Update TLE button logic
  document.getElementById('update-tle-btn').addEventListener('click', function () {
    const btn = this;
    const icon = document.getElementById('update-icon');
    btn.disabled = true;
    icon.textContent = '‚è≥';

    fetch('{{ url_for("passes.update_tle") }}')
      .then(res => res.json())
      .then(data => {
        icon.textContent = '‚úÖ';
        setTimeout(() => { location.reload(); }, 800);
      })
      .catch(err => {
        icon.textContent = '‚ö†Ô∏è';
        btn.disabled = false;
      });
  });

  // Single toggle button logic (uses /recordings/status, /recordings/enable, /recordings/disable)
  const toggleBtn = document.getElementById('toggleBtn');
  const statusText = document.getElementById('statusText');

  async function updateStatus() {
    try {
      const res = await fetch('/recordings/status');
      if (!res.ok) throw new Error('status not ok');
      const data = await res.json();
      const enabled = data.recording_enabled;

      statusText.textContent = enabled
        ? `‚úÖ Enabled${data.scheduler_pid ? ` (PID: ${data.scheduler_pid})` : ''}`
        : '‚ùå Disabled';

      if (enabled) {
        toggleBtn.textContent = 'Disable Recordings';
        toggleBtn.className = 'btn btn-danger';
        toggleBtn.onclick = async () => {
          await fetch('/recordings/disable', { method: 'POST' });
          updateStatus();
        };
      } else {
        toggleBtn.textContent = 'Enable Recordings';
        toggleBtn.className = 'btn btn-success';
        toggleBtn.onclick = async () => {
          await fetch('/recordings/enable', { method: 'POST' });
          updateStatus();
        };
      }
    } catch (err) {
      statusText.textContent = '‚ö†Ô∏è Error fetching status';
      toggleBtn.textContent = 'Retry';
      toggleBtn.className = 'btn btn-secondary';
      toggleBtn.onclick = updateStatus;
    }
  }

  // Poll status every 5 seconds
  setInterval(updateStatus, 5000);
  updateStatus();
</script>
{% endblock %}
