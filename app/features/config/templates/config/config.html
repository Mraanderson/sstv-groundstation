{% extends "base.html" %}
{% block title %}Configuration{% endblock %}
{% block content %}
<h1 class="mb-4">Configuration</h1>

<div class="card shadow-sm">
  <div class="card-body">
    <p class="text-muted">Click on the map to set your location. Latitude, longitude, and altitude will be filled automatically. Timezone is guessed from your location.</p>

    <div id="map" style="height: 400px;"></div>

    <form id="location-form" action="{{ url_for('config.config_page') }}" method="post" class="mt-3">
      <button type="submit" class="btn btn-primary mb-3">Save Location</button>

      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Latitude</label>
          <input type="text" id="lat" name="latitude" class="form-control" value="{{ latitude or '' }}" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Longitude</label>
          <input type="text" id="lon" name="longitude" class="form-control" value="{{ longitude or '' }}" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Altitude (m)</label>
          <input type="text" id="alt" name="altitude" class="form-control" value="{{ altitude or '' }}" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Timezone</label>
          <input type="text" id="tz" name="timezone" class="form-control" value="{{ timezone or '' }}" readonly>
        </div>
      </div>
    </form>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  const map = L.map('map').setView([{{ latitude or 0 }}, {{ longitude or 0 }}], {{ latitude and longitude and 8 or 2 }});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let marker;

  map.on('click', async function(e) {
    const lat = e.latlng.lat.toFixed(6);
    const lon = e.latlng.lng.toFixed(6);

    if (marker) { map.removeLayer(marker); }
    marker = L.marker([lat, lon]).addTo(map);

    document.getElementById('lat').value = lat;
    document.getElementById('lon').value = lon;

    // Fetch altitude from OpenTopoData
    try {
      const altRes = await fetch(`https://api.opentopodata.org/v1/srtm90m?locations=${lat},${lon}`);
      const altData = await altRes.json();
      const elevation = altData.results?.[0]?.elevation;
      document.getElementById('alt').value = typeof elevation === 'number' ? elevation : '';
    } catch {
      document.getElementById('alt').value = '';
    }

    // Fetch timezone
    try {
      const tzRes = await fetch(`https://timeapi.io/api/TimeZone/coordinate?latitude=${lat}&longitude=${lon}`);
      const tzData = await tzRes.json();
      document.getElementById('tz').value = tzData.timeZone || '';
    } catch {
      document.getElementById('tz').value = '';
    }
  });

  document.getElementById('location-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const alt = document.getElementById('alt').value;
    const tz = document.getElementById('tz').value;

    if (!alt || !tz) {
      alert('⏳ Please wait for altitude and timezone to load before saving.');
      return;
    }

    const res = await fetch(this.action, {
      method: 'POST',
      headers: { 'Accept': 'application/json' },
      body: new FormData(this)
    });

    const data = await res.json();
    if (data.error) {
      alert('❌ ' + data.error);
      return;
    }

    const confirmBox = document.createElement('div');
    confirmBox.className = 'alert alert-success mt-3';
    confirmBox.textContent = `✅ Config saved successfully at ${data.saved_time}`;
    this.parentNode.insertBefore(confirmBox, this);
    setTimeout(() => confirmBox.remove(), 3000);
  });
</script>
{% endblock %}
