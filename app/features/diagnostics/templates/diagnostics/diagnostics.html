{% extends "base.html" %}
{% block title %}Diagnostics{% endblock %}
{% block content %}
<h1>RTL‚ÄëSDR Diagnostics</h1>

<p>
This page helps you check that your RTL‚ÄëSDR dongle is connected, working correctly, and properly calibrated. 
Each section below runs a different test or maintenance task and explains why it matters.
</p>

<hr>

<h2>Dongle Presence Check</h2>
<!-- ... your existing dongle check markup ... -->

<hr>

<h2>System Status</h2>
<!-- ... your existing system status markup ... -->

<hr>

<h2>Calibration</h2>
<p>
Calibration measures how far your dongle‚Äôs internal clock drifts from true frequency. 
It scans the FM broadcast band, finds a strong station, and compares the measured frequency 
to the expected channel. The result is a <strong>PPM correction number</strong>. 
This number is then applied automatically to all future recordings so that when you tune 
to 145.800&nbsp;MHz (for example), you actually receive 145.800&nbsp;MHz instead of being offset. 
</p>
<p>
The page shows ‚Äúbefore‚Äù and ‚Äúafter‚Äù spectrograms so you can see the correction in action. 
If the ‚Äúbefore‚Äù image looks slanted or offset and the ‚Äúafter‚Äù image looks centred and stable, 
your calibration is working correctly.
</p>

<!-- New info box -->
<div class="alert alert-info">
  Why calibrate? SDR dongles use inexpensive crystal oscillators that can drift by tens of kHz. 
  Calibration measures this error and applies a correction (PPM). Without it, narrowband signals 
  like satellites may be missed or distorted. 
  <a href="https://osmocom.org/projects/rtl-sdr/wiki/Rtl-sdr" target="_blank">Learn more about SDR calibration</a>.
</div>

<!-- Current PPM display -->
<div id="ppmBox" class="alert alert-secondary">
  Current PPM correction: <span id="ppmValue">loading‚Ä¶</span>
</div>

<button id="calibrateBtn" class="btn btn-warning">üõ†Ô∏è Calibrate SDR</button>
<div id="calibrationResult" class="mt-3"></div>

<script>
document.getElementById("checkBtn").addEventListener("click", () => {
  // ... existing dongle check JS ...
});

async function updateStatus() {
  try {
    const res = await fetch("{{ url_for('diagnostics.diagnostics_status') }}");
    const data = await res.json();

    // ... your existing disk/pass/orphan logic ...

    // Update PPM box
    const ppmBox = document.getElementById("ppmBox");
    const ppmValue = document.getElementById("ppmValue");
    if (data.rtl_ppm !== undefined) {
      ppmValue.textContent = data.rtl_ppm + " ppm";
      if (data.rtl_ppm === 0) {
        ppmBox.className = "alert alert-warning";
        ppmBox.innerHTML = "‚ö†Ô∏è No calibration value found (using 0 ppm). Please run calibration.";
      }
    } else {
      ppmValue.textContent = "not available";
    }
  } catch (err) {
    // ... existing error handling ...
  }
}

// ... your existing clear/delete/calibrate JS ...

setInterval(updateStatus, 5000);
updateStatus();
</script>
{% endblock %}
