{% extends "base.html" %}
{% block title %}Diagnostics{% endblock %}
{% block content %}
<h1>RTL‚ÄëSDR Diagnostics</h1>

<p>
This page helps you check that your RTL‚ÄëSDR dongle is connected, working correctly, and properly calibrated. 
Each section below runs a different test or maintenance task and explains why it matters.
</p>

<hr>

<h2>Dongle Presence Check</h2>
<p>
This test runs <code>rtl_test</code> briefly to confirm that the SDR hardware is detected by the system 
and can stream samples. If successful, you‚Äôll see ‚ÄúDongle Present‚Äù and details about the tuner. 
If it fails, the dongle may not be plugged in, drivers may be missing, or another process may be using it.
</p>
<button id="checkBtn" class="btn btn-primary">Run Check</button>
<span id="statusBadge" class="badge bg-secondary ms-2">Not checked</span>
<pre id="outputBox" class="mt-3"></pre>

<hr>

<h2>System Status</h2>
<p>
This section shows free disk space, whether a satellite pass is currently being recorded, 
and the size of any ongoing IQ capture file. It also lists ‚Äúorphan‚Äù IQ files ‚Äî raw recordings 
left behind after a pass. These can be deleted to free up space.
</p>
<p id="diskInfo">Disk free: ‚Ä¶</p>
<p id="passInfo">Pass status: ‚Ä¶</p>

<h2>Orphan IQ Files</h2>
<p>
Orphan IQ files are recordings not linked to an active pass. They can take up a lot of space. 
You can delete them individually or clear them all at once. If disk space drops below a safe threshold, 
the system will auto‚Äëdelete them to protect ongoing captures.
</p>
<button id="clearAllIqBtn" class="btn btn-danger btn-sm mb-2">Clear All IQ Files</button>
<ul id="orphanList"><li>Loading‚Ä¶</li></ul>

<hr>

<h2>Calibration</h2>
<p>
Calibration measures how far your dongle‚Äôs internal clock drifts from true frequency. 
It scans the FM broadcast band, finds a strong station, and compares the measured frequency 
to the expected channel. The result is a <strong>PPM correction number</strong>. 
This number is then applied automatically to all future recordings so that when you tune 
to 145.800&nbsp;MHz (for example), you actually receive 145.800&nbsp;MHz instead of being offset. 
</p>
<p>
The page shows ‚Äúbefore‚Äù and ‚Äúafter‚Äù spectrograms so you can see the correction in action. 
If the ‚Äúbefore‚Äù image looks slanted or offset and the ‚Äúafter‚Äù image looks centred and stable, 
your calibration is working correctly.
</p>
<button id="calibrateBtn" class="btn btn-warning">üõ†Ô∏è Calibrate SDR</button>
<div id="calibrationResult" class="mt-3"></div>

<script>
document.getElementById("checkBtn").addEventListener("click", () => {
  fetch("{{ url_for('diagnostics.diagnostics_check') }}")
    .then(r => r.json())
    .then(data => {
      const badge = document.getElementById("statusBadge");
      const output = document.getElementById("outputBox");
      if (data.success) {
        badge.textContent = "Dongle Present";
        badge.className = "badge bg-success ms-2";
      } else {
        badge.textContent = "Not Detected";
        badge.className = "badge bg-danger ms-2";
      }
      output.textContent = data.output;
    })
    .catch(err => {
      document.getElementById("statusBadge").textContent = "Error";
      document.getElementById("statusBadge").className = "badge bg-warning ms-2";
      document.getElementById("outputBox").textContent = err;
    });
});

// Poll /status every 5 seconds
async function updateStatus() {
  try {
    const res = await fetch("{{ url_for('diagnostics.diagnostics_status') }}");
    const data = await res.json();

    document.getElementById("diskInfo").innerText =
      "Disk free: " + data.disk_free_gb + " GB";

    if (data.pass_info) {
      let msg = "Pass in progress: " + data.pass_info.satellite +
                " (IQ: " + data.pass_info.iq_file + ")";
      if (data.pass_info.iq_size_mb !== undefined) {
        msg += " ‚Äî size: " + data.pass_info.iq_size_mb + " MB";
      }
      document.getElementById("passInfo").innerText = msg;
    } else {
      document.getElementById("passInfo").innerText = "No pass in progress";
    }

    const list = document.getElementById("orphanList");
    list.innerHTML = "";
    if (data.orphan_iq && data.orphan_iq.length > 0) {
      data.orphan_iq.forEach(file => {
        const li = document.createElement("li");
        let text = file.path + " (" + file.size_mb + " MB)";
        if (file.deleted) text += " ‚Äî auto‚Äëdeleted (low disk space)";
        if (file.delete_error) text += " ‚Äî error: " + file.delete_error;
        li.textContent = text;

        if (!file.deleted) {
          const btn = document.createElement("button");
          btn.textContent = "Delete";
          btn.className = "btn btn-sm btn-danger ms-2";
          btn.onclick = async () => {
            await fetch("{{ url_for('diagnostics.delete_iq') }}", {
              method: "POST",
              headers: {"Content-Type": "application/json"},
              body: JSON.stringify({path: file.path})
            });
            updateStatus();
          };
          li.appendChild(btn);
        }
        list.appendChild(li);
      });
    } else {
      list.innerHTML = "<li>No orphan IQ files</li>";
    }

  } catch (err) {
    document.getElementById("diskInfo").innerText = "Disk free: error";
    document.getElementById("passInfo").innerText = "Pass status: error";
    document.getElementById("orphanList").innerHTML = "<li>Error loading orphan files</li>";
  }
}

// Clear All IQ Files button logic
document.getElementById("clearAllIqBtn").addEventListener("click", async function() {
  if (!confirm("Are you sure you want to delete ALL orphan IQ files?")) return;
  this.disabled = true;
  this.textContent = "Clearing...";
  try {
    const res = await fetch("{{ url_for('diagnostics.clear_all_iq') }}", {method: "POST"});
    const data = await res.json();
    if (data.success) {
      alert(`Deleted ${data.count} orphan IQ file(s).`);
    } else {
      alert("Failed to clear orphan IQ files.");
    }
  } catch (err) {
    alert("Error clearing orphan IQ files: " + err);
  }
  this.disabled = false;
  this.textContent = "Clear All IQ Files";
  updateStatus();
});

// Calibration button logic
document.getElementById("calibrateBtn").addEventListener("click", async function() {
  this.disabled = true;
  this.textContent = "Calibrating...";
  const resultBox = document.getElementById("calibrationResult");
  resultBox.innerHTML = "";
  try {
    const res = await fetch("{{ url_for('diagnostics.calibrate') }}", {method: "POST"});
    const data = await res.json();
    if (data.success) {
      resultBox.innerHTML = `
        <div class="alert alert-success">
          <strong>PPM correction:</strong> ${data.ppm}<br>
          <strong>Measured:</strong> ${data.measured_hz} Hz<br>
          <strong>Expected:</strong> ${data.expected_hz} Hz
        </div>
        <div class="row">
          <div class="col-md-6">
            <h6>Before</h6>
            <img src="/images/${data.png_before}" class="img-fluid border rounded">
          </div>
          <div class="col-md-6">
            <h6>After</h6>
            <img src="/images/${data.png_after}" class="img-fluid border rounded">
          </div>
        </div>`;
    } else {
      resultBox.innerHTML = `<div class="alert alert-danger">Calibration failed: ${data.error}</div>`;
    }
  } catch (err) {
    resultBox.innerHTML = `<div class="alert alert-warning">Error: ${err}</div>`;
  }
  this.disabled = false;
  this.textContent = "üõ†Ô∏è Calibrate SDR";
});

setInterval(updateStatus, 5000);
updateStatus();
</script>
{% endblock %}
