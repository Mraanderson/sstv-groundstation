{% extends "base.html" %}
{% block title %}Diagnostics{% endblock %}
{% block content %}
<h1>RTL‑SDR Diagnostics</h1>

<p>Click the button below to check if your RTL‑SDR dongle is present and streaming.</p>

<button id="checkBtn" class="btn btn-primary">Run Check</button>
<span id="statusBadge" class="badge bg-secondary ms-2">Not checked</span>

<pre id="outputBox" class="mt-3"></pre>

<hr>

<h2>System Status</h2>
<p id="diskInfo">Disk free: …</p>
<p id="passInfo">Pass status: …</p>

<script>
document.getElementById("checkBtn").addEventListener("click", () => {
  fetch("{{ url_for('diagnostics.diagnostics_check') }}")
    .then(r => r.json())
    .then(data => {
      const badge = document.getElementById("statusBadge");
      const output = document.getElementById("outputBox");
      if (data.success) {
        badge.textContent = "Dongle Present";
        badge.className = "badge bg-success ms-2";
      } else {
        badge.textContent = "Not Detected";
        badge.className = "badge bg-danger ms-2";
      }
      output.textContent = data.output;
    })
    .catch(err => {
      document.getElementById("statusBadge").textContent = "Error";
      document.getElementById("statusBadge").className = "badge bg-warning ms-2";
      document.getElementById("outputBox").textContent = err;
    });
});

// Poll /status every 5 seconds
async function updateStatus() {
  try {
    const res = await fetch("{{ url_for('diagnostics.diagnostics_status') }}");
    const data = await res.json();
    document.getElementById("diskInfo").innerText =
      "Disk free: " + data.disk_free_gb + " GB";
    if (data.pass_info) {
      document.getElementById("passInfo").innerText =
        "Pass in progress: " + data.pass_info.satellite +
        " (IQ: " + data.pass_info.iq_file + ")";
    } else {
      document.getElementById("passInfo").innerText = "No pass in progress";
    }
  } catch (err) {
    document.getElementById("diskInfo").innerText = "Disk free: error";
    document.getElementById("passInfo").innerText = "Pass status: error";
  }
}
setInterval(updateStatus, 5000);
updateStatus();
</script>
{% endblock %}
