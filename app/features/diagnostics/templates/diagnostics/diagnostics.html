{% extends "base.html" %}
{% block title %}Diagnostics - SSTV Groundstation{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-8">
    <h3>Diagnostics</h3>

    <div id="alerts"></div>

    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">SDR Status</h5>
        <p>
          <span id="pageSdrLight" class="badge bg-secondary">Checkingâ€¦</span>
        </p>
        <p id="sdrReason" class="text-muted small"></p>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Disk</h5>
        <p>Free: <strong id="diskFree">â€¦</strong> GB</p>
        <p>
          <span id="diskBadge" class="badge bg-secondary">Checkingâ€¦</span>
          <small class="text-muted ms-2">Requires at least 2 GB free</small>
        </p>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">RTL Settings</h5>
        <p>PPM: <span id="rtlPpm">{{ ppm }}</span></p>
        <p>Gain: <span id="rtlGain">{{ gain }}</span></p>
        <div class="d-flex gap-2">
          <button id="btnResetPpm" class="btn btn-sm btn-outline-secondary">Reset PPM</button>
          <button id="btnCalibrate" class="btn btn-sm btn-primary">Calibrate SDR</button>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Manual Recorder</h5>
        <form id="manualForm" method="post" action="{{ url_for('diagnostics.manual_recorder') }}">
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Frequency</label>
              <input name="frequency" class="form-control" value="145.800M">
            </div>
            <div class="col-md-2">
              <label class="form-label">Duration (s)</label>
              <input name="duration" type="number" class="form-control" value="30" min="1">
            </div>
            <div class="col-md-2">
              <label class="form-label">Gain</label>
              <input name="gain" class="form-control" value="{{ gain }}">
            </div>
            <div class="col-md-2">
              <label class="form-label">PPM</label>
              <input name="ppm" class="form-control" value="{{ ppm }}">
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button id="btnRecord" type="submit" class="btn btn-success w-100">Record</button>
            </div>
          </div>
        </form>
        <small class="form-text text-muted mt-2">If no dongle is present a demo recording will be created.</small>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Recent Manual Recordings</h5>
        <div id="recentList" class="list-group">
          {% for e in files %}
            <div class="list-group-item">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">{{ e.wav }}</h6>
                <small class="text-muted">{{ e.meta.duration if e.meta and e.meta.duration else "" }}</small>
              </div>
              <p class="mb-1">
                {% if e.png %}
                  <img src="{{ url_for('static', filename='diagnostics/manual/' ~ e.png) }}" alt="preview" class="img-fluid" style="max-width:240px;">
                {% endif %}
              </p>
              <small class="text-muted">{{ e.log or '' }}</small>
            </div>
          {% else %}
            <div class="list-group-item">No manual recordings yet.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <h5>System Requirements</h5>
    <ul id="reqList" class="list-group mb-3"></ul>
    <h5>Calibration / CSV preview</h5>
    <pre id="calPreview" class="small bg-light p-2" style="max-height:240px; overflow:auto"></pre>
  </div>
</div>

<script>
const statusUrl = "{{ url_for('diagnostics.diagnostics_status') }}";
const sdrStatusUrl = "{{ url_for('diagnostics.sdr_status') }}";
const calibrateUrl = "{{ url_for('diagnostics.calibrate') }}";
const resetPpmUrl = "{{ url_for('diagnostics.reset_ppm_route') }}";

let enoughSpace = false;

function showAlert(msg, cls="info", timeout=6000) {
  const a = document.createElement("div");
  a.className = `alert alert-${cls} alert-dismissible`;
  a.role = "alert";
  a.innerHTML = `${msg} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
  document.getElementById("alerts").appendChild(a);
  if (timeout) setTimeout(()=>{ try{ a.remove() }catch(e){} }, timeout);
}

async function updatePageStatus() {
  try {
    const res = await fetch(statusUrl, {cache: "no-store"});
    const data = await res.json();
    const df = document.getElementById("diskFree");
    const db = document.getElementById("diskBadge");
    df.textContent = data.disk_free_gb !== null ? data.disk_free_gb : "error";
    enoughSpace = !!data.enough_space;
    db.className = enoughSpace ? "badge bg-success" : "badge bg-danger";
    db.textContent = enoughSpace ? "Enough space" : "Low space";
    // requirements
    const reqList = document.getElementById("reqList");
    reqList.innerHTML = "";
    if (data.requirements) {
      for (const [k,v] of Object.entries(data.requirements)) {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.textContent = k;
        const span = document.createElement("span");
        span.className = v ? "badge bg-success" : "badge bg-danger";
        span.textContent = v ? "OK" : "MISSING";
        li.appendChild(span);
        reqList.appendChild(li);
      }
    }
    // rtl settings
    if (data.rtl_ppm !== undefined) document.getElementById("rtlPpm").textContent = data.rtl_ppm;
    if (data.rtl_gain !== undefined) document.getElementById("rtlGain").textContent = data.rtl_gain;
  } catch (err) {
    document.getElementById("diskFree").textContent = "error";
    document.getElementById("diskBadge").className = "badge bg-warning";
    document.getElementById("diskBadge").textContent = "Error";
  }
}

async function updateSdrLightLocal() {
  try {
    const res = await fetch(sdrStatusUrl, {cache: "no-store"});
    const data = await res.json();
    const el = document.getElementById("pageSdrLight");
    const map = {
      green: {cls: "badge bg-success", text: "ðŸŸ¢ SDR Ready"},
      red:   {cls: "badge bg-danger", text: "ðŸ”´ SDR In Use"},
      amber: {cls: "badge bg-warning text-dark", text: "ðŸŸ  SDR Scheduled"},
      grey:  {cls: "badge bg-secondary", text: "âšª SDR Missing"}
    };
    const st = map[data.status] || map.grey;
    el.className = st.cls;
    el.textContent = st.text;
    document.getElementById("sdrReason").textContent = data.reason || "";
  } catch (err) {
    const el = document.getElementById("pageSdrLight");
    el.className = "badge bg-warning";
    el.textContent = "SDR Error";
  }
}

document.getElementById("btnCalibrate").addEventListener("click", async () => {
  const btn = document.getElementById("btnCalibrate");
  btn.disabled = true;
  btn.textContent = "Calibratingâ€¦";
  try {
    const res = await fetch(calibrateUrl, {method: "POST"});
    const data = await res.json();
    if (data.success) {
      showAlert("Calibration complete (PPM: " + data.ppm + ")", "success");
      document.getElementById("calPreview").textContent = (data.csv_preview || []).join("\n");
      // update ppm shown
      document.getElementById("rtlPpm").textContent = data.ppm;
    } else {
      showAlert("Calibration failed: " + (data.error || "unknown"), "danger");
    }
  } catch (err) {
    showAlert("Calibration error: " + err, "danger");
  } finally {
    btn.disabled = false;
    btn.textContent = "Calibrate SDR";
  }
});

document.getElementById("btnResetPpm").addEventListener("click", async () => {
  const b = document.getElementById("btnResetPpm");
  b.disabled = true;
  try {
    const res = await fetch(resetPpmUrl, {method: "POST"});
    const data = await res.json();
    if (data.success) {
      document.getElementById("rtlPpm").textContent = data.ppm;
      showAlert("PPM reset to 0", "success");
    } else {
      showAlert("Reset failed: " + (data.error || "unknown"), "danger");
    }
  } catch (err) {
    showAlert("Reset error: " + err, "danger");
  } finally {
    b.disabled = false;
  }
});

document.getElementById("manualForm").addEventListener("submit", (ev) => {
  if (!enoughSpace) {
    ev.preventDefault();
    if (confirm("Disk space is low. Proceed with recording anyway?")) {
      // allow submission despite low space
      ev.target.submit();
    }
  }
});

// initial update + polling
updatePageStatus();
updateSdrLightLocal();
setInterval(updatePageStatus, 5000);
setInterval(updateSdrLightLocal, 5000);
</script>
{% endblock %}