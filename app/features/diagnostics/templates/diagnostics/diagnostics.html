{% extends "base.html" %}
{% block title %}Diagnostics{% endblock %}
{% block content %}
<h1>RTL‑SDR Diagnostics</h1>

<p>Click the button below to check if your RTL‑SDR dongle is present and streaming.</p>

<button id="checkBtn" class="btn btn-primary">Run Check</button>
<span id="statusBadge" class="badge bg-secondary ms-2">Not checked</span>

<pre id="outputBox" class="mt-3"></pre>

<hr>

<h2>System Status</h2>
<p id="diskInfo">Disk free: …</p>
<p id="passInfo">Pass status: …</p>

<h2>Orphan IQ Files</h2>
<ul id="orphanList"><li>Loading…</li></ul>

<script>
document.getElementById("checkBtn").addEventListener("click", () => {
  fetch("{{ url_for('diagnostics.diagnostics_check') }}")
    .then(r => r.json())
    .then(data => {
      const badge = document.getElementById("statusBadge");
      const output = document.getElementById("outputBox");
      if (data.success) {
        badge.textContent = "Dongle Present";
        badge.className = "badge bg-success ms-2";
      } else {
        badge.textContent = "Not Detected";
        badge.className = "badge bg-danger ms-2";
      }
      output.textContent = data.output;
    })
    .catch(err => {
      document.getElementById("statusBadge").textContent = "Error";
      document.getElementById("statusBadge").className = "badge bg-warning ms-2";
      document.getElementById("outputBox").textContent = err;
    });
});

// Poll /status every 5 seconds
async function updateStatus() {
  try {
    const res = await fetch("{{ url_for('diagnostics.diagnostics_status') }}");
    const data = await res.json();

    // Disk free
    document.getElementById("diskInfo").innerText =
      "Disk free: " + data.disk_free_gb + " GB";

    // Pass info
    if (data.pass_info) {
      let msg = "Pass in progress: " + data.pass_info.satellite +
                " (IQ: " + data.pass_info.iq_file + ")";
      if (data.pass_info.iq_size_mb !== undefined) {
        msg += " — size: " + data.pass_info.iq_size_mb + " MB";
      }
      document.getElementById("passInfo").innerText = msg;
    } else {
      document.getElementById("passInfo").innerText = "No pass in progress";
    }

    // Orphan IQ files
    const list = document.getElementById("orphanList");
    list.innerHTML = "";
    if (data.orphan_iq && data.orphan_iq.length > 0) {
      data.orphan_iq.forEach(file => {
        const li = document.createElement("li");
        let text = file.path + " (" + file.size_mb + " MB)";
        if (file.deleted) {
          text += " — auto‑deleted (low disk space)";
        }
        if (file.delete_error) {
          text += " — error: " + file.delete_error;
        }
        li.textContent = text;

        if (!file.deleted) {
          const btn = document.createElement("button");
          btn.textContent = "Delete";
          btn.className = "btn btn-sm btn-danger ms-2";
          btn.onclick = async () => {
            await fetch("{{ url_for('diagnostics.delete_iq') }}", {
              method: "POST",
              headers: {"Content-Type": "application/json"},
              body: JSON.stringify({path: file.path})
            });
            updateStatus();
          };
          li.appendChild(btn);
        }
        list.appendChild(li);
      });
    } else {
      list.innerHTML = "<li>No orphan IQ files</li>";
    }

  } catch (err) {
    document.getElementById("diskInfo").innerText = "Disk free: error";
    document.getElementById("passInfo").innerText = "Pass status: error";
    document.getElementById("orphanList").innerHTML = "<li>Error loading orphan files</li>";
  }
}
setInterval(updateStatus, 5000);
updateStatus();
</script>
{% endblock %}
